version: 2

sources:
  - name: "scooters_raw"
    description: "Raw data provided by scooters service"
    loader: "https://t.me/inzhenerka_dbt_bot"
    tables:
      - name: "trips"
        description: "Scooter trips"

      - name: "users"
        description: "Users of scooter service"
      - name: "events"
        description: "Events table with duplicates"


models:
  - name: trips_prep
    description: "Preprocessed scooter trips data with calculated metrics and cleaned pricing"
    config:
      materialized: view
    columns:
      - name: id
        description: "Unique identifier for the trip"
      - name: user_id
        description: "ID of the user who took the trip"
      - name: scooter_hw_id
        description: "Hardware ID of the scooter used"
      - name: started_at
        description: "Timestamp when the trip started"
      - name: finished_at
        description: "Timestamp when the trip ended"
      - name: start_lat
        description: "Latitude of trip start location"
      - name: start_lon
        description: "Longitude of trip start location"
      - name: finish_lat
        description: "Latitude of trip end location"
      - name: finish_lon
        description: "Longitude of trip end location"
      - name: distance_m
        description: "Trip distance in meters"
      - name: price_rub
        description: "Trip price in Russian rubles"
      - name: duration_s
        description: "Trip duration in seconds"
      - name: is_free
        description: "Boolean indicating if the trip was free (price = 0 but duration > 0)"
      - name: date
        description: "Date when the trip started"
  - name: trips_stat
    description: "Trip stats model"
    config:
      materialized: table
    columns:
      - name: trips
        description: "count trips"
      - name: users
        description: "count distinct users"
      - name: avg_duration_m
        description: "avg duration_min"
      - name: revenue_rub
        description: "sum over price_rub field"
      - name: free_trips_pct
        description: "casing is_free field"
      - name: sum_distance_km
        description: "sum of distance_m divided by 1000"
  - name: trips_stat_daily
    description: "daily trip statistics"
    config:
      materialized: table
      indexes: [
                {'columns': ['date']} #OR SIMPLY - columns: ["date"] AFTER INDEXES FROM THE NEW LINE
      ]
  - name: trips_age_daily
    description: "daily trips stats by user age"
  - name: trips_age_daily_stat
    description: "aggregation of daily trips stats by user age"
  - name: trips_geom
    description: "new model with geo data"
    config:
      materialized: view
  - name: parking_start_stat
    description: "new model hexagons in the map detecting the start location of the trip "
    config:
      materialized: table
  - name: parking_finish_stat
    description: "new model hexagons in the map detecting the finish location of the trip "
    config:
      materialized: table
  - name: trips_users
    description: "trips_prep join with source table trips"
    config:
      materialized: incremental
  - name: events_clean
    description: "Events table from src database without duplicates"
    config:
      materialized: incremental
  - name: revenue_daily
    description: "model where we find the revenure per day"
    config:
      materialized: incremental
      incremental_strategy: merge
      unique_key: ['date']
      on_schema_change: 'append_new_columns'
      full_refresh: false
  - name: trips_concurrency
    description: "model counting the number of concurrent trips (active at the same time)"
    config:
      materialized: incremental
  - name: companies
    description: "a new model with scooters companies statistics based on info from seed"
  - name: companies_trips
    description: "Trip satistics by company"
  - name: events_full
    description: "Enriched events_clean with type_id from seed file called event_types"
    config:
      materialized: view
  - name: "events_stat"
    description: "Overall user events statistics"


# Обращаться к источнику из любой модели теперь нужно будет строго через макрос:
# {{ source("<name>", "<table_name>") }}